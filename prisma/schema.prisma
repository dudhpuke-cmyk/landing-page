// Prisma schema for Dudhpuke - future-ready, not connected to a live database yet.
// PostgreSQL-ready, with clear relations for users, customers, subscriptions and orders.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  name      String?
  email     String?  @unique
  phone     String?  @unique
  password  String?  // For password-based auth if needed later; can be omitted when using OAuth only.
  role      UserRole @default(CUSTOMER)

  // Relations
  customer       Customer?
  subscriptions  Subscription[]
  orders         Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Customer {
  id          String   @id @default(cuid())
  fullName    String
  phone       String   @unique
  email       String?  @unique
  addressLine String
  city        String
  region      String
  postalCode  String?
  country     String   @default("NP")

  // Relations
  user           User?          @relation(fields: [userId], references: [id])
  userId         String?        @unique
  subscriptions  Subscription[]
  orders         Order[]
  deliveries     Delivery[]
  reviews        Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  description String?
  status      ProductStatus @default(ACTIVE) // ACTIVE, COMING_SOON, DISCONTINUED
  unit        String        // e.g. "litre", "kg"
  basePrice   Decimal       @db.Decimal(10, 2)

  // Flags for UI / feature toggles
  isSubscriptionEnabled Boolean @default(true)
  isVisibleOnSite       Boolean @default(true)

  // Relations
  subscriptions Subscription[]
  orderItems    OrderItem[]
  reviews       Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id              String            @id @default(cuid())
  customer        Customer          @relation(fields: [customerId], references: [id])
  customerId      String
  user            User?             @relation(fields: [userId], references: [id])
  userId          String?
  product         Product           @relation(fields: [productId], references: [id])
  productId       String

  planType        SubscriptionPlan  @default(DAILY) // DAILY, MONTHLY, CUSTOM
  quantityPerDay  Decimal?          @db.Decimal(10, 2)
  billingCycle    BillingCycle      @default(MONTHLY)
  startDate       DateTime
  endDate         DateTime?
  isActive        Boolean           @default(true)
  notes           String?

  orders          Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id              String       @id @default(cuid())
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id])
  subscriptionId  String?

  customer        Customer     @relation(fields: [customerId], references: [id])
  customerId      String

  user            User?        @relation(fields: [userId], references: [id])
  userId          String?

  status          OrderStatus  @default(PENDING)

  scheduledDate   DateTime?
  deliveredDate   DateTime?

  totalAmount     Decimal      @db.Decimal(10, 2)
  currency        String       @default("NPR")

  paymentProvider PaymentProvider? // e.g. Razorpay later
  paymentRef      String?

  orderItems      OrderItem[]
  delivery        Delivery?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id         String   @id @default(cuid())
  order      Order    @relation(fields: [orderId], references: [id])
  orderId    String
  product    Product  @relation(fields: [productId], references: [id])
  productId  String

  quantity   Decimal  @db.Decimal(10, 2)
  unitPrice  Decimal  @db.Decimal(10, 2)
  lineTotal  Decimal  @db.Decimal(10, 2)
}

model Delivery {
  id             String        @id @default(cuid())
  customer       Customer      @relation(fields: [customerId], references: [id])
  customerId     String

  order          Order?        @relation(fields: [orderId], references: [id])
  orderId        String?       @unique

  scheduledDate  DateTime
  deliveredDate  DateTime?

  status         DeliveryStatus @default(SCHEDULED)
  addressLine    String
  city           String
  region         String
  postalCode     String?
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id          String    @id @default(cuid())
  rating      Int       // 1â€“5
  comment     String?

  customer    Customer  @relation(fields: [customerId], references: [id])
  customerId  String

  product     Product?  @relation(fields: [productId], references: [id])
  productId   String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum UserRole {
  ADMIN
  CUSTOMER
}

enum ProductStatus {
  ACTIVE
  COMING_SOON
  DISCONTINUED
}

enum SubscriptionPlan {
  DAILY
  MONTHLY
  CUSTOM
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum DeliveryStatus {
  SCHEDULED
  OUT_FOR_DELIVERY
  DELIVERED
  SKIPPED
}

enum PaymentProvider {
  RAZORPAY
  CASH
  BANK_TRANSFER
  OTHER
}

